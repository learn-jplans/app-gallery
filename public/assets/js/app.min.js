window.App=window.App||{},window.App.SearchPlace={init:function(){var e=this;e.handler(),e.installSelect2Widget(),App.Maps.getNearbyPlaces()},handler:function(){$(document).on("change","#searchPlaceType",function(e){App.Maps.clearRoute(),App.Maps.getInitLocation(),App.Maps.getNearbyPlaces()}),$(document).on("click","#sort",function(e){App.Maps.sortPlaces()}),$(document).on("click",".table tr",function(e){var t=$(this),a=t.data();$(".table tr").css("background","#FFF"),t.css("background","#ebebeb"),$("#walk").data("lat",a.lat),$("#walk").data("lng",a.lng),$("#drive").data("lat",a.lat),$("#drive").data("lng",a.lng),App.Maps.bounceMarker(a.id,!0)}),$(document).on("click","#walk",function(e){var t=$(this).data();App.Maps.drawRoute(t.lat,t.lng,"walking")}),$(document).on("click","#drive",function(e){var t=$(this).data();App.Maps.drawRoute(t.lat,t.lng,"driving")}),$(document).on("mouseout",".table tr",function(e){var t=$(this),a=t.data();App.Maps.bounceMarker(a.id,!1)})},installSelect2Widget:function(){$("#searchPlaceType").select2({data:category})}},window.App=window.App||{},window.App.Maps={$mapContainer:$("#map-canvas"),defaultZoomLevel:10,autoComplete:!1,region:"PH",map:!1,directionsDisplay:!1,mapCenter:!1,markers:{},mapBounds:!1,userLocation:!1,currentLocation:!1,mapLoaded:!1,selectedLat:0,selectedLng:0,count:0,lastInfoWindow:!1,"default":{lat:13.9490476,lng:121.1579272,location:"Lipa Batangas, PH",zoomLevel:17},init:function(){var e=this;e.loadMapScript()},loadMapScript:function(){var e=document.createElement("script");e.type="text/javascript",e.src="//maps.googleapis.com/maps/api/js?v=3.exp&language=en&sensor=false&libraries=places,geometry&callback=App.Maps.mapScriptLoaded",document.body.appendChild(e)},mapScriptLoaded:function(){var e=this;e.loadMap(e.$mapContainer,null,function(e){e.getInitLocation(),e.mapLoaded=!0,App.SearchPlace.init()})},eventHandler:function(){var e=this;google.maps.event.addListener(e.map,"click",function(t){e.selectedLat=t.latLng.lat(),e.selectedLng=t.latLng.lng(),console.log(e.selectedLat),console.log(e.selectedLng)})},loadMap:function(e,t,a){var n=this;if(t=t||{},0===e.length)return!1;n["default"]=$.extend(n["default"],t),n.mapCenter=new google.maps.LatLng(n["default"].lat,n["default"].lng),n.currentLocation=n.mapCenter;var o={zoom:n["default"].zoomLevel,center:n.mapCenter,scrollwheel:!1,mapTypeControl:!1,panControl:!1,scaleControl:!0,zoomControl:!0,streetViewControl:!1,zoomControlOptions:{style:google.maps.ZoomControlStyle.LARGE,position:google.maps.ControlPosition.TOP_RIGHT}};e.ready(function(){n.map=new google.maps.Map(e[0],o),n.directionsDisplay=new google.maps.DirectionsRenderer({suppressMarkers:!0}),n.directionsDisplay.setMap(n.map),"function"==typeof a&&a(n)}),n.eventHandler()},getNearbyPlaces:function(){var e=this,t=$("#searchPlaceType option:selected").val(),a={location:this.currentLocation,radius:1500,types:[t]};e.clearMarker();var n=new google.maps.places.PlacesService(e.map);$(".loader").show(),n.nearbySearch(a,function(t,a,n){a!=google.maps.places.PlacesServiceStatus.OK?setTimeout(function(){e.getNearbyPlaces()},500):(e.createMarkers(t),n.hasNextPage)})},createMarkers:function(e){{var t=this;new google.maps.places.PlacesService(t.map)}$(".table tbody").html("");for(var a,n=0;a=e[n];n++){var o=a.geometry.location;t.insertMarker(o,a.id,a),t.getDetails(a)}$(".loader").hide()},getDetails:function(e){var t=this,a={reference:e.reference};service=new google.maps.places.PlacesService(t.map),service.getDetails(a,function(a,n){n==google.maps.places.PlacesServiceStatus.OK?t.renderPlaces(a):n===google.maps.GeocoderStatus.OVER_QUERY_LIMIT&&setTimeout(function(){t.getDetails(e)},200)})},renderPlaces:function(e){var t=this,a=$("#searchEntryTemplate").html(),n=_.template(a)({id:e.id,name:e.name,address:e.formatted_address,position:e.geometry.location,distance:t.computeDistance(t.currentLocation,e.geometry.location)});$(".table tbody").append(n)},sortPlaces:function(){$(".table tr").sortElements(function(e,t){return $(e).data().distance>$(t).data().distance?1:-1})},drawRoute:function(e,t,a){var n=new google.maps.DirectionsService,o=App.Maps.currentLocation,r=App.Maps.getLatLng(e,t),i=!1;"walking"===a?i=google.maps.TravelMode.WALKING:"driving"===a&&(i=google.maps.TravelMode.DRIVING);var s={origin:o,destination:r,travelMode:i};n.route(s,function(e,t){t==google.maps.DirectionsStatus.OK&&App.Maps.directionsDisplay.setDirections(e)})},clearRoute:function(){this.directionsDisplay.setDirections({routes:[]})},getInitLocation:function(e,t){var a=this;t?(a.mapCenter=new google.maps.LatLng(e,t),a.currentLocation=a.mapCenter,a.userLocation=a.mapCenter,a.map.setZoom(a["default"].zoomLevel),a.map.setCenter(a.mapCenter),a.geolocationInProgress=!1,a.initDefaultGeoInterval=setInterval(function(){a.geolocationInProgress||clearInterval(a.initDefaultGeoInterval)},200)):navigator.geolocation&&(a.geolocationInProgress=!0,navigator.geolocation.getCurrentPosition(function(e){a.mapCenter=new google.maps.LatLng(e.coords.latitude,e.coords.longitude),a.currentLocation=a.mapCenter,a.userLocation=a.mapCenter,a.map.setZoom(a["default"].zoomLevel),a.map.setCenter(a.mapCenter),a.geolocationInProgress=!1,a.ownMarker(a.currentLocation,231)},function(e){a.geolocationInProgress=!1},{maximumAge:6e5,timeout:1e4}),a.initDefaultGeoInterval=setInterval(function(){a.geolocationInProgress||clearInterval(a.initDefaultGeoInterval)},200))},ownMarker:function(e,t){{var a="/assets/images/circle-marker.png";new google.maps.Marker({position:e,map:this.map,icon:a})}},insertMarker:function(e,t,a){var n=this;if(n.mapLoaded){var o={placeId:a.place_id},r=new google.maps.places.PlacesService(n.map),i=new google.maps.Marker({position:e,map:n.map,tag:t});n.markers[String(t)]=i,google.maps.event.addListener(i,"click",function(){r.getDetails(o,function(e,t){if(t==google.maps.places.PlacesServiceStatus.OK){var a="<h3>"+e.name+"</h3>",o="<span><strong>Address:</strong></span>",r="<p>"+e.adr_address+"</p>",s="<span><strong>Contact #:</strong></span>",c="<p>"+(_.isUndefined(e.formatted_phone_number)?" N/A":e.formatted_phone_number)+"</p>",l="<span><strong>Website:</strong></span>",p="<p>"+(_.isUndefined(e.website)?" N/A":'<a target="_blank" href="'+e.website+'">'+e.website+"</a>")+"</p>",u=a+o+r+s+c+l+p;n.lastInfoWindow&&n.lastInfoWindow.close();var d=new google.maps.InfoWindow({content:u,maxWidth:200});d.open(n.map,i),n.lastInfoWindow=d}})})}else setTimeout(function(){n.insertMarker(e,t,a)},200)},bounceMarker:function(e,t){var a=this;if("undefined"==typeof a.markers[e])return!1;"undefined"==typeof a.markers[e].isBounce&&(a.markers[e].isBounce=!t);var n=a.markers[e];return n.isBounce==t?!1:(a.markers[e].isBounce=t,void(t?(n.setAnimation(google.maps.Animation.BOUNCE),a.map.panTo(n.getPosition())):n.setAnimation(null)))},clearMarker:function(){var e=this;$.each(Object.keys(e.markers),function(t,a){e.markers[a].setMap(null)}),e.markers=[],e.mapBounds=!1,e.currentStores=[]},getLatLng:function(e,t){return new google.maps.LatLng(e,t)},computeDistance:function(e,t){var a=google.maps.geometry.spherical.computeDistanceBetween(e,t);return a}},$(function(){App.Maps.init()}),jQuery.fn.sortElements=function(){var e=[].sort;return function(t,a){a=a||function(){return this};var n=this.map(function(){var e=a.call(this),t=e.parentNode,n=t.insertBefore(document.createTextNode(""),e.nextSibling);return function(){if(t===this)throw new Error("You can't sort elements if any one is a descendant of another.");t.insertBefore(this,n),t.removeChild(n)}});return e.call(this,t).each(function(e){n[e].call(a.call(this))})}}(),App.util={format:function(e){return e.toFixed(2).replace(/./g,function(e,t,a){return t>0&&"."!==e&&(a.length-t)%3===0?","+e:e})},formatDistance:function(e){return e>=1e3?this.format(e/1e3)+" km":this.format(e)+" m"},capitalize:function(e){return e.replace(/\b\w/g,function(e){return e.toUpperCase()})}};