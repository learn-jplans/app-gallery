window.App=window.App||{},window.App.SearchPlace={init:function(){this.handler(),this.installSelect2Widget()},handler:function(){$(document).on("change","#searchPlaceType",function(e){App.Maps.mapScriptLoaded()}),$(document).on("click","#sort",function(e){App.Maps.sortPlaces()}),$(document).on("click",".table tr",function(e){var t=$(this),n=t.data();App.Maps.bounceMarker(n.id,!0)}),$(document).on("mouseout",".table tr",function(e){var t=$(this),n=t.data();App.Maps.bounceMarker(n.id,!1)})},installSelect2Widget:function(){$("#searchPlaceType").select2({data:category})}},$(function(){App.SearchPlace.init()}),window.App=window.App||{},window.App.Maps={$mapContainer:$("#map-canvas"),defaultZoomLevel:10,autoComplete:!1,region:"PH",map:!1,mapCenter:!1,markers:{},mapBounds:!1,userLocation:!1,currentLocation:!1,mapLoaded:!1,selectedLat:0,selectedLng:0,count:0,lastInfoWindow:!1,"default":{lat:13.9490476,lng:121.1579272,location:"Lipa Batangas, PH",zoomLevel:17},init:function(){var e=this;e.loadMapScript()},loadMapScript:function(){var e=document.createElement("script");e.type="text/javascript",e.src="//maps.googleapis.com/maps/api/js?v=3.exp&language=en&sensor=false&libraries=places,geometry&callback=App.Maps.mapScriptLoaded",document.body.appendChild(e)},mapScriptLoaded:function(){var e=this;e.loadMap(e.$mapContainer,null,function(e){e.getInitLocation(),e.mapLoaded=!0})},eventHandler:function(){var e=this;google.maps.event.addListener(e.map,"click",function(t){e.selectedLat=t.latLng.lat(),e.selectedLng=t.latLng.lng(),console.log(e.selectedLat),console.log(e.selectedLng)})},loadMap:function(e,t,n){var a=this;if(t=t||{},0===e.length)return!1;a["default"]=$.extend(a["default"],t),a.mapCenter=new google.maps.LatLng(a["default"].lat,a["default"].lng),a.currentLocation=a.mapCenter;var o={zoom:a["default"].zoomLevel,center:a.mapCenter,scrollwheel:!1,mapTypeControl:!1,panControl:!1,scaleControl:!0,zoomControl:!0,streetViewControl:!1,zoomControlOptions:{style:google.maps.ZoomControlStyle.LARGE,position:google.maps.ControlPosition.TOP_RIGHT}};e.ready(function(){a.map=new google.maps.Map(e[0],o),"function"==typeof n&&n(a)}),a.eventHandler()},getNearbyPlaces:function(){var e=this,t=$("#searchPlaceType option:selected").val(),n={location:this.currentLocation,types:[t],rankBy:google.maps.places.RankBy.DISTANCE},a=new google.maps.places.PlacesService(e.map);a.nearbySearch(n,function(t,n,a){n==google.maps.places.PlacesServiceStatus.OK&&(e.createMarkers(t),a.hasNextPage)})},createMarkers:function(e){{var t=this;new google.maps.places.PlacesService(t.map)}$(".table tbody").html("");for(var n,a=0;n=e[a];a++){var o=n.geometry.location;t.insertMarker(o,n.id,n),t.getDetails(n)}},getDetails:function(e){var t=this,n={reference:e.reference};service=new google.maps.places.PlacesService(t.map),service.getDetails(n,function(n,a){a==google.maps.places.PlacesServiceStatus.OK?t.renderPlaces(n):a===google.maps.GeocoderStatus.OVER_QUERY_LIMIT&&setTimeout(function(){t.getDetails(e)},500)})},renderPlaces:function(e){var t=this;console.log(e);var n=$("#searchEntryTemplate").html(),a=_.template(n)({id:e.id,name:e.name,address:e.formatted_address,distance:t.computeDistance(t.currentLocation,e.geometry.location)});$(".table tbody").append(a)},sortPlaces:function(){$(".table tr").sortElements(function(e,t){return $(e).data().distance>$(t).data().distance?1:-1}),console.log("sorting...")},getInitLocation:function(e,t){var n=this;t?(n.mapCenter=new google.maps.LatLng(e,t),n.currentLocation=n.mapCenter,n.userLocation=n.mapCenter,n.map.setZoom(n["default"].zoomLevel),n.map.setCenter(n.mapCenter),n.geolocationInProgress=!1,n.initDefaultGeoInterval=setInterval(function(){n.geolocationInProgress||clearInterval(n.initDefaultGeoInterval)},200)):navigator.geolocation&&(n.geolocationInProgress=!0,navigator.geolocation.getCurrentPosition(function(e){n.mapCenter=new google.maps.LatLng(e.coords.latitude,e.coords.longitude),n.currentLocation=n.mapCenter,n.userLocation=n.mapCenter,n.map.setZoom(n["default"].zoomLevel),n.map.setCenter(n.mapCenter),n.geolocationInProgress=!1,n.getNearbyPlaces()},function(e){n.geolocationInProgress=!1},{maximumAge:6e5,timeout:1e4}),n.initDefaultGeoInterval=setInterval(function(){n.geolocationInProgress||clearInterval(n.initDefaultGeoInterval)},200))},insertMarker:function(e,t,n){var a=this;if(a.mapLoaded){var o={placeId:n.place_id},r=new google.maps.places.PlacesService(a.map),i=new google.maps.Marker({position:e,map:a.map,tag:t});a.markers[String(t)]=i,google.maps.event.addListener(i,"click",function(){r.getDetails(o,function(e,t){if(t==google.maps.places.PlacesServiceStatus.OK){console.log(e);var n="<h3>"+e.name+"</h3>",o="<span><strong>Address:</strong></span>",r="<p>"+e.adr_address+"</p>",s="<span><strong>Contact #:</strong></span>",c="<p>"+(_.isUndefined(e.formatted_phone_number)?" N/A":e.formatted_phone_number)+"</p>",l="<span><strong>Website:</strong></span>",p="<p>"+(_.isUndefined(e.website)?" N/A":'<a target="_blank" href="'+e.website+'">'+e.website+"</a>")+"</p>",u=n+o+r+s+c+l+p;a.lastInfoWindow&&a.lastInfoWindow.close();var m=new google.maps.InfoWindow({content:u,maxWidth:200});m.open(a.map,i),a.lastInfoWindow=m}})})}else setTimeout(function(){a.insertMarker(e,t,n)},100)},bounceMarker:function(e,t){var n=this;if("undefined"==typeof n.markers[e])return!1;"undefined"==typeof n.markers[e].isBounce&&(n.markers[e].isBounce=!t);var a=n.markers[e];return a.isBounce==t?!1:(n.markers[e].isBounce=t,void(t?(a.setAnimation(google.maps.Animation.BOUNCE),n.map.panTo(a.getPosition())):a.setAnimation(null)))},clearMarker:function(){var e=this;$.each(e.markers,function(e,t){t.setMap(null)}),e.markers=[],e.mapBounds=!1,e.currentStores=[]},getLongLat:function(e,t){return new google.maps.LatLng(e,t)},computeDistance:function(e,t){var n=google.maps.geometry.spherical.computeDistanceBetween(e,t);return n/1e3}},$(function(){App.Maps.init()}),jQuery.fn.sortElements=function(){var e=[].sort;return function(t,n){n=n||function(){return this};var a=this.map(function(){var e=n.call(this),t=e.parentNode,a=t.insertBefore(document.createTextNode(""),e.nextSibling);return function(){if(t===this)throw new Error("You can't sort elements if any one is a descendant of another.");t.insertBefore(this,a),t.removeChild(a)}});return e.call(this,t).each(function(e){a[e].call(n.call(this))})}}(),App.util={format:function(e){return e.toFixed(2).replace(/./g,function(e,t,n){return t>0&&"."!==e&&(n.length-t)%3===0?","+e:e})},capitalize:function(e){return e.replace(/\b\w/g,function(e){return e.toUpperCase()})}};